apiVersion: v1
kind: ConfigMap
metadata:
  name: kdl-server-configmap
  labels:
    app: kdl-server-configmap
data:
  KDL_SERVER_PORT: '8080'

  # URL Setup
  PROJECT_FILEBROWSER_URL: "{{ include "protocol" . }}://kdlapp.{{ .Values.domain }}/filebrowser/PROJECT_ID/"
  MINIO_ENDPOINT: "{{ .Release.Name }}-minio:9000"
  USER_TOOLS_JUPYTER_URL: "{{ include "protocol" . }}://USERNAME-jupyter.{{ .Values.domain }}/lab/workspaces/REPO_FOLDER/tree/repos/REPO_FOLDER"
  USER_TOOLS_VSCODE_URL: "{{ include "protocol" . }}://USERNAME-code.{{ .Values.domain }}/?folder=/home/coder/repos/REPO_FOLDER"
  DRONE_URL: "{{ include "protocol" . }}://drone.{{ .Values.domain }}"
  PROJECT_MLFLOW_URL: "{{ include "protocol" . }}://kdlapp.{{ .Values.domain }}/mlflow/PROJECT_ID/"
  KNOWLEDGE_GALAXY_URL: "{{ include "protocol" . }}://kdlapp.{{ .Values.domain }}/kg/projects/PROJECT_ID/"

  config.json: |+
    {
      "SERVER_NAME": "{{ .Values.serverName }}",
      "SERVER_URL": "{{ include "protocol" . }}://kdlapp.{{ .Values.domain }}",
      "KNOWLEDGE_GALAXY_ENABLED": {{ .Values.knowledgeGalaxy.enabled }},
      "KG_SERVER_URL": "{{ include "protocol" . }}://kdlapp.{{ .Values.domain }}/kg",
      "GITEA_URL": "{{ include "protocol" . }}://gitea.{{ .Values.domain }}",
      "RELEASE_VERSION": "{{ .Chart.AppVersion }}",
      "DESCRIPTION_MIN_WORDS": {{ default "50" .Values.knowledgeGalaxy.config.descriptionMinWords }}
    }

  OAUTH2_PROXY_IMG_REPO: "{{ .Values.oauth2Proxy.image.repository }}"
  OAUTH2_PROXY_IMG_TAG: "{{ .Values.oauth2Proxy.image.tag }}"
  OAUTH2_PROXY_IMG_PULLPOLICY: "{{ .Values.oauth2Proxy.image.pullPolicy }}"

  GITEA_OAUTH2_SETUP_IMG_REPO: "{{ .Values.giteaOauth2Setup.image.repository }}"
  GITEA_OAUTH2_SETUP_IMG_TAG: "{{ .Values.giteaOauth2Setup.image.tag }}"
  GITEA_OAUTH2_SETUP_IMG_PULLPOLICY: "{{ .Values.giteaOauth2Setup.image.pullPolicy }}"

  KNOWLEDGE_GALAXY_ENABLED: "{{ .Values.knowledgeGalaxy.enabled }}"

  PROJECT_MLFLOW_IMG_REPO: "{{ .Values.projectOperator.mlflow.image.repository }}"
  PROJECT_MLFLOW_IMG_TAG: "{{ .Values.projectOperator.mlflow.image.tag }}"
  PROJECT_MLFLOW_IMG_PULLPOLICY: "{{ .Values.projectOperator.mlflow.image.pullPolicy }}"
  PROJECT_MLFLOW_STORAGE_CLASS_NAME: "{{ .Values.projectOperator.mlflow.volume.storageClassName}}"
  PROJECT_MLFLOW_STORAGE_SIZE: "{{ .Values.projectOperator.mlflow.volume.size}}"

  PROJECT_FILEBROWSER_IMG_REPO: "{{ .Values.projectOperator.filebrowser.image.repository }}"
  PROJECT_FILEBROWSER_IMG_TAG: "{{ .Values.projectOperator.filebrowser.image.tag }}"
  PROJECT_FILEBROWSER_IMG_PULLPOLICY: "{{ .Values.projectOperator.filebrowser.image.pullPolicy }}"

  VSCODE_IMG_REPO: "{{ .Values.userToolsOperator.vscode.image.repository }}"
  VSCODE_IMG_TAG: "{{ .Values.userToolsOperator.vscode.image.tag }}"
  VSCODE_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.vscode.image.pullPolicy }}"

  JUPYTER_IMG_REPO: "{{ .Values.userToolsOperator.jupyter.image.repository }}"
  JUPYTER_IMG_TAG: "{{ .Values.userToolsOperator.jupyter.image.tag }}"
  JUPYTER_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.jupyter.image.pullPolicy }}"
  JUPYTER_ENTERPRISE_GATEWAY_URL: http://enterprise-gateway:{{ index .Values "enterprise-gateway" "port" }}

  REPO_CLONER_IMG_REPO: "{{ .Values.userToolsOperator.repoCloner.image.repository }}"
  REPO_CLONER_IMG_TAG: "{{ .Values.userToolsOperator.repoCloner.image.tag }}"
  REPO_CLONER_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.repoCloner.image.pullPolicy }}"

  {{- if kindIs "invalid" .Values.userToolsOperator.giteaOauth2Setup }}
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_REPO: "{{ .Values.giteaOauth2Setup.image.repository }}"
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_TAG: "{{ .Values.giteaOauth2Setup.image.tag }}"
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_PULLPOLICY: "{{ .Values.giteaOauth2Setup.image.pullPolicy }}"
  {{- else }}
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_REPO: "{{ .Values.userToolsOperator.giteaOauth2Setup.image.repository }}"
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_TAG: "{{ .Values.userToolsOperator.giteaOauth2Setup.image.tag }}"
  USER_TOOLS_GITEA_OAUTH2_SETUP_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.giteaOauth2Setup.image.pullPolicy }}"
  {{- end }}

  USER_TOOLS_OAUTH2_PROXY_IMG_REPO: "{{ .Values.userToolsOperator.oauth2Proxy.image.repository }}"
  USER_TOOLS_OAUTH2_PROXY_IMG_TAG: "{{ .Values.userToolsOperator.oauth2Proxy.image.tag }}"
  USER_TOOLS_OAUTH2_PROXY_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.oauth2Proxy.image.pullPolicy }}"

  USER_TOOLS_VSCODE_RUNTIME_IMG_REPO: "{{ .Values.userToolsOperator.vscodeRuntime.image.repository }}"
  USER_TOOLS_VSCODE_RUNTIME_IMG_TAG: "{{ .Values.userToolsOperator.vscodeRuntime.image.tag }}"
  USER_TOOLS_VSCODE_RUNTIME_IMG_PULLPOLICY: "{{ .Values.userToolsOperator.vscodeRuntime.image.pullPolicy }}"

  USER_TOOLS_KUBECONFIG_DOWNLOAD_ENABLED: "{{ .Values.userToolsOperator.kubeconfig.enabled }}"
  USER_TOOLS_KUBECONFIG_EXTERNAL_SERVER_URL: "{{ .Values.userToolsOperator.kubeconfig.externalServerUrl }}"

  USER_TOOLS_STORAGE_SIZE: {{ .Values.userToolsOperator.storage.size }}
  USER_TOOLS_STORAGE_CLASSNAME: {{ .Values.userToolsOperator.storage.storageClassName }}

  TOOLKIT_BASE_DOMAIN_NAME: {{ .Values.domain }}
  TOOLKIT_INGRESS_TYPE: {{ .Values.ingress.type }}
  TOOLKIT_SHARED_VOLUME: {{ .Values.sharedVolume.name }}
  TOOLKIT_TLS: "{{ .Values.tls.enabled }}"
  {{- if and .Values.tls.enabled .Values.tls.secretName }}
  TOOLKIT_TLS_SECRET_NAME: {{ include "tlsSecretName" . }}
  {{- end }}
